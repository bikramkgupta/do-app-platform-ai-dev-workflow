spec:
  #
  # DigitalOcean App Platform Specification
  # Simplified Development Environment with GitHub Sync
  #
  # This spec deploys a dev environment that automatically syncs a GitHub
  # repository and runs your application for fast iteration cycles.
  #

  name: dev-environment
  region: syd1

  services:
    - name: dev-workspace
      # Use Dockerfile from repository
      dockerfile_path: hot-reload-template/Dockerfile

      # GitHub repository (this repository will be used for the dev environment itself)
      github:
        repo: bikram20/do-app-platform-ai-dev-workflow
        branch: main
        deploy_on_push: true

      # Service type - worker with HTTP health check
      instance_count: 1
      instance_size_slug: apps-s-1vcpu-1gb

      # Internal port for health check
      internal_ports:
      - 9090

      # HTTP port for your application traffic (health check uses dedicated port below)
      http_port: 8080

      # Health check configuration
      # Uses /dev_health endpoint which is always available (even without user app)
      health_check:
        http_path: /dev_health
        initial_delay_seconds: 30
        period_seconds: 10
        timeout_seconds: 5
        success_threshold: 1
        failure_threshold: 5
        port: 9090

      # Environment variables
      envs:
        # === Build Arguments ===
        # Runtime and database client installation (BUILD_TIME scope)
        # Enable only the runtimes you need for faster builds
        - key: INSTALL_NODE
          value: "true"  # Node.js/Next.js/Remix apps (optional - health server uses Go binary)
          scope: BUILD_TIME
        - key: INSTALL_PYTHON
          value: "true"  # Python/FastAPI/Django apps
          scope: BUILD_TIME
        - key: INSTALL_GOLANG
          value: "true"  # Go apps
          scope: BUILD_TIME
        - key: INSTALL_RUST
          value: "false"  # Rust apps
          scope: BUILD_TIME
        - key: INSTALL_POSTGRES
          value: "true"
          scope: BUILD_TIME
        - key: INSTALL_MONGODB
          value: "false"
          scope: BUILD_TIME
        - key: INSTALL_MYSQL
          value: "false"
          scope: BUILD_TIME

        # === GitHub Repository to Clone ===
        # Set this to the repository you want to work on
        - key: GITHUB_REPO_URL
          value: ""
          scope: RUN_TIME

        # === GitHub Authentication ===
        # Required for private repositories
        - key: GITHUB_TOKEN
          value: ""
          scope: RUN_TIME
          type: SECRET

        # === Workspace Configuration ===
        - key: WORKSPACE_PATH
          value: "/workspaces/app"
          scope: RUN_TIME

        - key: GITHUB_SYNC_INTERVAL
          value: "15"
          scope: RUN_TIME

        # === Dev Health Server ===
        # Built-in Go binary serving /dev_health on port 9090 for bootstrap health checks
        # Set to "false" when your app provides its own health endpoint
        - key: ENABLE_DEV_HEALTH
          value: "true"
          scope: RUN_TIME

        # === Application Startup ===
        # Command to run your application (if startup.sh not found in repo)
        # Examples:
        #   - "npm start"
        #   - "python app.py"
        #   - "go run main.go"
        #   - "uvicorn app:app --host 0.0.0.0 --port 8080"
        - key: RUN_COMMAND
          value: ""
          scope: RUN_TIME

        # === Monorepo Support ===
        # Specify subfolder within the repo to sync (for monorepos)
        - key: GITHUB_REPO_FOLDER
          value: ""
          scope: RUN_TIME

        # === Branch Selection ===
        # Specify which branch to sync (useful for feature/staging branches)
        - key: GITHUB_BRANCH
          value: ""
          scope: RUN_TIME

  # Optional: Add alerts
  alerts:
    - rule: DEPLOYMENT_FAILED
    - rule: DOMAIN_FAILED
