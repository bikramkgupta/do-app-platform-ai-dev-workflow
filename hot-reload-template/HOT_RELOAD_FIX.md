# Hot-Reload Sync Performance Fix

## Problem Identified

The hot-reload sync was taking a long time because when new commits were pushed to GitHub, the sync script detected them but failed to pull due to local modifications (particularly `package-lock.json` files modified by npm install).

### Root Cause

1. **Git fetch succeeds** - The script successfully detects new commits on the remote
2. **Git pull fails** - When `package-lock.json` or other lock files have local modifications (from npm install), `git pull` refuses to fast-forward
3. **Error message**: `Your branch is behind 'origin/main' by X commits, and can be fast-forwarded. (use "git pull" to update your local branch)`
4. **Result**: The script detects new commits but doesn't actually pull them until the next sync cycle, and even then it might fail again

### Why This Happens

When `npm install` runs (triggered by nodemon detecting package.json changes), it modifies `package-lock.json`. These local modifications prevent git from performing a fast-forward merge, causing `git pull` to fail with errors like:
- "would be overwritten by merge"
- "Your local changes to the following files would be overwritten by merge"

## Solution Implemented

The fix adds proactive handling before attempting to pull:

1. **Check if branch is behind** - Before attempting pull, check if local branch is behind remote
2. **Detect fast-forward capability** - Verify that a fast-forward is possible
3. **Proactively reset lock files** - If branch is behind and can fast-forward, reset lock files that have local modifications (since they'll be regenerated anyway by npm/go/uv)
4. **Better error handling** - Improved error detection and handling for different pull failure scenarios

### Key Changes

```bash
# Before pull, check if branch is behind
LOCAL_COMMIT=$(git rev-parse HEAD)
REMOTE_COMMIT=$(git rev-parse "origin/$CURRENT_BRANCH")

if branch_is_behind && can_fast_forward; then
    # Proactively reset lock files that have local changes
    for lockfile in package-lock.json go.sum uv.lock poetry.lock; do
        if has_local_changes; then
            git checkout -- "$lockfile"  # Reset to committed version
        fi
    done
fi

# Now pull should succeed
git pull origin "$CURRENT_BRANCH"
```

## Benefits

1. **Faster sync** - Changes are pulled immediately when detected, not delayed
2. **More reliable** - Proactive handling prevents pull failures
3. **Lock files handled correctly** - Lock files are reset before pull and will be regenerated by dependency managers
4. **Better logging** - More informative log messages about what's happening

## Testing

To test the fix:
1. Push a change to GitHub
2. Wait for sync interval (15-30 seconds)
3. Check logs - should see "Branch is behind. Preparing for fast-forward..."
4. Lock files should be reset automatically
5. Pull should succeed immediately

## Files Modified

- `hot-reload-template/scripts/github-sync.sh` - Added proactive lock file handling before pull

## Related Files

- `hot-reload-template/app-examples/*/dev_startup.sh` - These scripts already handle lock file conflicts during npm install, but the sync script now prevents conflicts before they occur

