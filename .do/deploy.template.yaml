spec:
  #
  # DigitalOcean App Platform Specification
  # Simplified Development Environment with GitHub Sync
  #
  # This spec deploys a dev environment that automatically syncs a GitHub
  # repository and runs your application for fast iteration cycles.
  #

  name: rails-dev-environment
  region: syd1

  services:
    - name: rails-workspace
      # Use Dockerfile from repository
      dockerfile_path: hot-reload-template/Dockerfile

      # GitHub repository (this repository will be used for the dev environment itself)
      git:
        branch: main
        repo_clone_url: https://github.com/bikramkgupta/do-app-platform-ai-dev-workflow.git

      # Service type - worker with HTTP health check
      instance_count: 1
      instance_size_slug: apps-s-1vcpu-1gb

      # Internal port for application
      #internal_ports:
      #- 8080

      # HTTP port for your application traffic (health check uses dedicated port below)
      http_port: 8080

      # Health check configuration
      # Points to Rails health endpoint
      health_check:
        http_path: /health
        initial_delay_seconds: 300  # Rails takes longer to start (bundle install ~3min + boot)
        period_seconds: 10
        timeout_seconds: 10
        success_threshold: 1
        failure_threshold: 6
        port: 8080

      # Environment variables
      envs:
        # === Template Tracking ===
        - key: APPPLAT_BASE_TEMPLATE
          value: "hot-reload-template"
          scope: RUN_TIME
        - key: APPPLAT_TEMPLATE_TYPE
          value: "base"
          scope: RUN_TIME
        - key: APPPLAT_TEMPLATE_VERSION
          value: "1.0.0"
          scope: RUN_TIME

        # === Build Arguments ===
        # Runtime and database client installation (BUILD_TIME scope)
        # Enable only the runtimes you need for faster builds
        - key: INSTALL_NODE
          value: "false"
          scope: BUILD_TIME
        - key: INSTALL_PYTHON
          value: "false"
          scope: BUILD_TIME
        - key: INSTALL_GOLANG
          value: "false"
          scope: BUILD_TIME
        - key: INSTALL_RUST
          value: "false"
          scope: BUILD_TIME
        - key: INSTALL_RUBY
          value: "true"  # Ruby on Rails sample app
          scope: BUILD_TIME
        - key: RUBY_VERSIONS
          value: "3.4.7"
          scope: BUILD_TIME
        - key: DEFAULT_RUBY
          value: "3.4.7"
          scope: BUILD_TIME
        - key: INSTALL_POSTGRES
          value: "true"  # Rails often uses Postgres
          scope: BUILD_TIME
        - key: INSTALL_MONGODB
          value: "false"
          scope: BUILD_TIME
        - key: INSTALL_MYSQL
          value: "false"
          scope: BUILD_TIME

        # === GitHub Repository to Clone ===
        # Default: Next.js sample app (ready to run)
        - key: GITHUB_REPO_URL
          value: "https://github.com/bikramkgupta/do-app-platform-ai-dev-workflow"
          scope: RUN_TIME

        # === GitHub Authentication ===
        # Required for private repositories
        - key: GITHUB_TOKEN
          value: ""
          scope: RUN_TIME
          type: SECRET

        # === Workspace Configuration ===
        - key: WORKSPACE_PATH
          value: "/workspaces/app"
          scope: RUN_TIME

        - key: GITHUB_SYNC_INTERVAL
          value: "15"
          scope: RUN_TIME

        # === Dev Health Server ===
        # Built-in Go binary serving /dev_health on port 9090 for bootstrap health checks
        # Set to "false" when your app provides its own health endpoint
        - key: ENABLE_DEV_HEALTH
          value: "false"
          scope: RUN_TIME

        # === Application Startup ===
        # RECOMMENDED: Use a dev_startup.sh script to handle all corner cases.
        # Scripts can manage dependency installation, lock file conflicts, error recovery,
        # and hot reload properly. See hot-reload-template/examples/ for proven scripts.
        # 
        # Example: "bash dev_startup.sh"
        #
        # Simple commands (NOT RECOMMENDED - limited error handling):
        #   - "npm run dev -- --hostname 0.0.0.0 --port 8080"
        #   - "python app.py"
        #   - "go run main.go"
        #   - "uvicorn app:app --host 0.0.0.0 --port 8080"
        #   Note: Simple commands don't handle dependency installation, lock file conflicts,
        #   or automatic error recovery. Use scripts for production-ready setups.
        - key: DEV_START_COMMAND
          value: "bash dev_startup.sh"
          scope: RUN_TIME

        # === Monorepo Support ===
        # Rails sample app folder
        - key: GITHUB_REPO_FOLDER
          value: "hot-reload-template/app-examples/ruby-rails-sample"
          scope: RUN_TIME

        # === Branch Selection ===
        - key: GITHUB_BRANCH
          value: "main"
          scope: RUN_TIME

        # === Pre-Deploy Job Configuration ===
        # Jobs execute only when git commit changes (not every sync)
        - key: PRE_DEPLOY_REPO_URL
          value: ""
          scope: RUN_TIME
        - key: PRE_DEPLOY_FOLDER
          value: "scripts/pre-deploy"
          scope: RUN_TIME
        - key: PRE_DEPLOY_COMMAND
          value: "bash migrate.sh"
          scope: RUN_TIME
        - key: PRE_DEPLOY_TIMEOUT
          value: "300"
          scope: RUN_TIME

        # === Post-Deploy Job Configuration ===
        - key: POST_DEPLOY_REPO_URL
          value: ""
          scope: RUN_TIME
        - key: POST_DEPLOY_FOLDER
          value: "scripts/post-deploy"
          scope: RUN_TIME
        - key: POST_DEPLOY_COMMAND
          value: "bash seed.sh"
          scope: RUN_TIME
        - key: POST_DEPLOY_TIMEOUT
          value: "300"
          scope: RUN_TIME

  # Optional: Add alerts
  alerts:
    - rule: DEPLOYMENT_FAILED
    - rule: DOMAIN_FAILED
